<!doctype html>
<html lang="en" class="stop-scrolling">
<head>
  <title>Moorhen</title>
  <base href="[[baseurl]]" />
  <meta charset="utf-8"/>
  <link rel="icon"             href="./favicon.ico"/>
  <meta name="viewport"        content="width=device-width,initial-scale=1"/>
  <meta name="theme-color"     content="#000000"/>
  <meta name="description"     content="Web site created using create-react-app"/>
  <link rel="apple-touch-icon" href="./public/logo192.png"/>
  <link rel="manifest"         href="./manifest.json"/>
</head>
<body>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <div id="root"></div>
  <script>// See https://github.com/facebook/react/issues/20829#issuecomment-802088260
    if (!crossOriginIsolated) SharedArrayBuffer = ArrayBuffer;
  </script>
  <script src="./baby-gru/wasm/web_example.js"></script>
  <script src="./moorhen.js"      charset="utf-8"></script>
  <script type="text/javascript"  defer="defer">

    const rootId      = 'root';
    const mode        = '[[mode]]';
    const inputFiles  = [[inputFiles]];
    const interval    = [[interval]];
    const no_data_msg = '[[no_data_msg]]';
    const preferences = [[preferences]];
    const sf_meta     = [[meta]];
    const urlPrefix   = '.';

    if (window.addEventListener) {
      window.addEventListener ( 'message', onWindowMessage, false );
    } else if (window.attachEvent) {
      window.attachEvent ( 'onmessage', onWindowMessage, false );
    } else 
      alert ( 'No Window messaging in iframe!' );

    function onWindowMessage ( event )  {
      alert ( event.data.message );
    }

    const exportToCloudCallback = (molName,molData) => {
      window.parent.postMessage ({
          'command' : 'saveFile',
          'fpath'   : molName + '.pdb',
          'data'    : molData,
          'confirm' : true,
          'meta'    : sf_meta
          // 'callback' : window
      }, window.location );
    }
    const savePreferencesCallback = (preferences) => {
      window.parent.postMessage ({
          'command' : 'saveWebCootPreferences',
          'data'    : JSON.parse(JSON.stringify(preferences))
      }, window.location );
    }

    let BACKUPS = [];
   
    const saveBackupCallback = (obj) => {
      return new Promise((resolve, reject) => {
        window.parent.postMessage ({
            'command' : 'saveFile',
            'fpath'   : 'backups/backup_' + obj.serNo,
            'data'    : JSON.stringify(obj.data),
            'confirm' : false,
            'meta'    : sf_meta
        }, window.location );
        obj.data = null;
        BACKUPS.push ( obj );
        window.parent.postMessage ({
            'command' : 'saveFile',
            'fpath'   : 'backups/backups.json',
            'data'    : JSON.stringify(BACKUPS),
            'confirm' : false,
            'meta'    : sf_meta
        }, window.location );
        resolve();
      });
    }

    // this.loadBackupCallback = (serNo) => {
    //     return new Promise((resolve, reject) => {
    //         resolve(this.BACKUPS.find(i => i.serNo === serNo))
    //     })
    // }

    // this.removeBackupCallback = (serNo) => {
    //     return new Promise((resolve, reject) => {
    //         this.BACKUPS = this.BACKUPS.filter(i => i.serNo !== serNo)
    //         resolve()
    //     })
    // }

    // this.loadBackupList = () => {
    //     return new Promise((resolve, reject) => {
    //         resolve(this.BACKUPS)
    //     })
    // }

    let moorhenWrapper = new moorhen.MoorhenWrapper ( urlPrefix );
    if (preferences)  {
      moorhenWrapper.setPreferences ( preferences );
    }
    if (no_data_msg)
      moorhenWrapper.setNoDataLegendMessage ( no_data_msg );
    moorhenWrapper.addOnChangePreferencesListener ( savePreferencesCallback );

    switch (mode)  {  
      case "view-update" : moorhenWrapper.setWorkMode         ( 'view' );
                          //  moorhenWrapper.addOnExportListener ( exportToCloudCallback );
                          //  moorhenWrapper.setRootId           ( rootId     );
                          //  moorhenWrapper.setInputFiles       ( inputFiles );
                           moorhenWrapper.setUpdateInterval   ( interval   );
                          //  moorhenWrapper.start()
                       break;
      case "view"        : moorhenWrapper.setWorkMode         ( 'view' );
                          //  moorhenWrapper.addOnExportListener ( exportToCloudCallback );
                          //  moorhenWrapper.setRootId           ( rootId     );
                          //  moorhenWrapper.setInputFiles       ( inputFiles );
                          //  moorhenWrapper.start()
                       break;
      default            : // moorhenWrapper.addOnExportListener ( exportToCloudCallback );
                           // moorhenWrapper.setBackupSaveListener ( saveBackupCallback    );
                          //  moorhenWrapper.setRootId           ( rootId     );
                          //  moorhenWrapper.setInputFiles       ( inputFiles );
                          //  moorhenWrapper.start()
    }

    moorhenWrapper.addOnExportListener ( exportToCloudCallback );
    moorhenWrapper.setRootId           ( rootId     );
    moorhenWrapper.setInputFiles       ( inputFiles );
    moorhenWrapper.start();

</script>
</body>
</html>
