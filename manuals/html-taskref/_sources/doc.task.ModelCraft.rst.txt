========================================
Automatic Model Building with Modelcraft
========================================

ModelCraft is an automated model-building pipeline for X-ray crystallography. It is based on the `BUCCANEER <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Buccaneer.html>`_ and `NAUTILUS <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Nautilus.html>`_ model-building pipelines, but with the following enhancements:

- Building of protein, RNA and DNA in a single pipeline.

- Preliminary refinement of the input model using `SHEETBEND <https://pure.york.ac.uk/portal/en/publications/sheetbend-software-for-model-morphing-of-atomic-models(497dd49d-c29c-4958-863b-18563a7dde17).html>`_.

- Machine-learned pruning of protein residues and chains.

- Density modification using `PARROT <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Parrot.html>`_ and dummy-atom addition.

- Addition of water molecules using `COOT <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.CootMB.html>`_.

- Running for an increased number of cycles with automatic stopping criteria.

- Selecting the best output model from all cycles.

- Final rebuilding of side chains using `COOT <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.CootMB.html>`_.

--------
Workflow
--------

If a starting model was provided, ModelCraft refines it with `shift-field refinement <https://journals.iucr.org/d/issues/2020/12/00/di5041/>`_ using `SHEETBEND <https://pure.york.ac.uk/portal/en/publications/sheetbend-software-for-model-morphing-of-atomic-models(497dd49d-c29c-4958-863b-18563a7dde17).html>`_ followed by 10 cycles of `REFMAC <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Refmac.html>`_

A **single cycle of ModelCraft** consists of the following seven steps: 

1. **Prune incorrect protein chains, residues and side chains** using `COOT <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.CootMB.html>`_ followed by 5 cycles of `REFMAC <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Refmac.html>`_.

      The pruning algorithm deletes chains, residues and side chains using two neural networks, which were trained to predict main-chain and side-chain correctness by combining many validation metrics. **This step is not performed on the first cycle or if the resolution is 2.3 Å or worse.**

2. **Density modification** using `Parrot <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Parrot.html>`_ (map improvement step).

3. **Add dummy atoms** using `COOT <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.CootMB.html>`_ followed by 10 cycles of `REFMAC <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Refmac.html>`_.

      Dummy atoms are pseudo atoms that are added to an atomic model to represent unknown scattering matter. They do not have a chemical identity but are assigned an element, often oxygen, so their contribution to the structure factor equation can be calculated. As dummy atoms do not represent real atom sites with known bonding, they are refined without geometry restraints. However, at high resolution, it is often possible to determine individual atomic positions even with unrestrained refinement. At lower resolution, the unrestrained atoms will become over-fitted, but it could still be beneficial to include them even without accurate parameters. In ModelCraft, they are only used as a tool for phase improvement and are discarded after refinement. **The dummy atom refinement is only accepted if it produces a lower free-R factor. Otherwise, the map from the previous step will be used.**

4. **Build protein** using `BUCCANEER <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Buccaneer.html>`_ followed by 10 cycles of `REFMAC <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Refmac.html>`_.

5. **Prune incorrect protein chains** using `COOT <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.CootMB.html>`_ followed by 5 cycles of `REFMAC <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Refmac.html>`_.

      Buccaneer may build small chain fragments in the solvent regions or through the density for other components. It is important to remove these so they do not block the building of RNA, DNA or ordered waters.

6. **Build RNA and DNA** using `NAUTILUS <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Nautilus.html>`_ followed by 10 cycles of `REFMAC <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Refmac.html>`_.

7. **Add waters** using `COOT <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.CootMB.html>`_ followed by 10 cycles of `REFMAC <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Refmac.html>`_.

      As in the third step, the model with waters is only accepted if it has a better R-free than the model without waters.

**The model from the cycle with lowest R-work is chosen as the output**. If the resolution is better than 2.5 Å and R-work is better than 30% ModelCraft **rebuilds side chains** using `COOT <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.CootMB.html>`_ followed by 5 cycles of `REFMAC <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Refmac.html>`_. This side chain rebuilding step is performed once at the end of the pipeline to fix side chains that are either missing or predicted to be in incorrect conformations.

-----
Input
-----

Two **build modes** are available. In **basic mode** ModelCraft uses only `BUCCANEER <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Buccaneer.html>`_, `NAUTILUS <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Nautilus.html>`_ and `REFMAC <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Refmac.html>`_. `PARROT <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Parrot.html>`_ density modification is only used on the first cycle.

**The pipeline will stop if the model does not improve** for 4 cycles by default (setting this value to less than 1 makes ModelCraft run to the maximum number of cycles). A cycle must improve on the previous best value to be marked as an improvement. **Improvement is measured by R-work**. 

**Before running ModelCraft:**

   - **Remove incorrect parts of the model**. ModelCraft has steps for pruning the protein structure, but it may help the pipeline to do this yourself first.

   - **Include non-incorporated heavy atoms in the input model** (i.e. not S or Se that are part of the protein) as doing so should improve the phases. ModelCraft will avoid clashes with these atoms so **only include atoms if you are confident of their positions**.

------
Output
------

**If ModelCraft didn't produce a good output model:**

   - Improve the initial model or phases. For example, try another molecular replacement model or use `PARROT <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Parrot.html>`_ or `ACORN <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Acorn.html>`_ for density modification.

   - Interactively prune/build the output model in `COOT <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.CootMB.html>`_ and re-submit that as an input model.

   - Try other model building programs (`CCP4Build <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.CCP4Build.html>`_, `Buccaneer <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.Buccaneer.html>`_, `ARP/wARP <https://cloud.ccp4.ac.uk/manuals/html-taskref/doc.task.ArpWarp.html>`_) with either the same input as ModelCraft or the partially-built output model.

------------
Useful links
------------

`ModelCraft web page <https://paulsbond.co.uk/modelcraft/>`_

`GitHub <https://github.com/paulsbond/modelcraft>`_


----------------
Acknowledgements
----------------

This article uses materials kindly provided by **Paul Bond**, whose help is greatly appreciated.


----------
References
----------

`Bond, P. & Cowtan, K. ModelCraft: an advanced automated model-building pipeline using Buccaneer. Acta Crystallographica Section D 78 (2022) <https://doi.org/10.1107/S2059798322007732>`_

`Cowtan, K., Metcalfe, S. & Bond, P. Shift-field refinement of macromolecular atomic models. Acta Crystallographica Section D 76, 1192–1200 (2020) <https://doi.org/10.1107/S2059798320013170>`_
