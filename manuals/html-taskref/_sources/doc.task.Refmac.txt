=======
REFMAC5
=======

`REFMAC5 <https://journals.iucr.org/d/issues/2011/04/00/ba5152/index.html>`_ is a program designed for REFinement of MACromolecular structures. It’s final step in the process of solving a macromolecular crystal (MX) structure, refinement is carried out to maximize the agreement between the model and the X-ray data. Model parameters that are optimized in the refinement process include atomic coordinates, atomic displacement parameters (ADPs), scale factors and, in the presence of twinning, twin fraction(s).  It uses Maximum likelihood and some elements of Bayesian Statististics.

*Although refinement procedures are typically designed for the final stages of MX analysis, they are also often used to improve partial models and to calculate the `best' electron-density maps for further model (re)building.*


------------------------------
Basic principles of refinement
------------------------------
refinement is a process of fitting the atomic model into observed X-ray crystallographic data. Allows the atomic model to be visualized, criticized and analyzed direct relation between model quality and phase quality. We need to Iteratively improve the model to optimize the agreement between **F** :subscript:`obs` and **F** :subscript:`calc`

We work with two types of maps:


• **2F** :subscript:`obs` **- F** :subscript:`calc` : “standard” electron density - represents crystal contents

• **F** :subscript:`obs` **- F** :subscript:`calc` : difference density - represents differences
    
 ``Data of different quality shall be described differently (the difference in quality tells us about how many statistics we have for the atom, that why different number parameters of the model could be estimated given particular data).``

 ``The model is defined not only about the PDB file, but also should consider the parameters of the refinement program.``

*Before applying bulk solvent scaling and including all low resolution data, check your distribution of <F> looks sensible. This is the raw material for all overall scaling algorithms. A good way to check this is to look at a <Fsq> plot against resolution.*


------------------------
Stages of model building
------------------------

**Early stages (e.g. straight after MR)**

• Run many cycles (up to 200 with jelly body restraints) of refinement

**Medium stages – during model building**

• 10-20 cycles
• Optimise additional parameters like NCS, TLS, etc
• Once your Rfree is lower than 40%, turn on twinning if twinned

.. warning::
            **DON’T USE TWIN REFINEMENT IF YOUR Rfree IS HIGHER THAN 40%!**
            
• Play with geometry weight parameter

**Final stages of refinement**

• Use optimal additional parameters

• If geometrical quality of the model is not optimal, further play with parameters like geometry weight.

----------------------
Model Parameterisation
----------------------

+++++++++
B-factors
+++++++++

 **describe relative positional uncertainty**

Atomic displacement parameters, or B-values, are an integral part of atomic models. They reﬂect the mobility of atoms.

Atomic B-factors can be modelled in a different way according to the quality of the data: **anisotropic** (6 parameters per atom, for better than 1.5 Å resolution), **isotropic** (1 parameter per atom), **TLS** (20 parameters per group of atoms)

*B-factors are sometimes also referred to as atomic displacement parameters (ADPs) or thermal/temperature factors*

    ``Should not compare atomic B-factors between different models``

B-values have various roles: 

    * They reﬂect atomic mobility, thus refning the B-values increases the agreement between the observed data and the refned model; 
    
    * When atoms are incorrectly placed, the atomic B-values become large, reﬂecting errors in the model. 
     
        It is generally expected for neighboring atoms to have similar B-values in regions where modeled atoms are positioned suffciently accurately. If neighboring atoms have wildly different B-values after refnement, it usually means that some of the atoms are either in the wrong place; or  otherwise incorrectly parameterized (e.g., the occupancies and/or element types for some of the atoms are wrong).

        B-values of bonded atoms will be more similar to each other than those of atoms that are spatially close but non-bonded. 

One of the problems with absolute atomic B-values is that if one adds/removes a constant B-value to/from all atoms then the average B-value will change accordingly. If there are no negative B-values as a result of such an operation then it will only affect the scale of observed versus calculated structure factors, as well as causing the resultant density map to be blurred/sharpened. Consequently, one can manipulate the B-values of atoms (or structure factors) without changing the information content of the data. 

This has two consequences:
 
    1. Average B-values or Wilson B-values are not good indicators of data quality/resolution.

    2. Restraints based on B-values may not be accurate if they involve anything other than the differences between B-values

++++++++++
TLS Groups
++++++++++
 
 **describe anisotropic motion**

`TLS Motion Determination (TLSMD) <http://skuld.bmsc.washington.edu/~tlsmd/>`_ analyzes a macromolecular crystal structure for evidence of flexibility, e.g. local or inter-domain motions. It does this by partitioning individual chains into multiple segments that are modeled as rigid bodies undergoing TLS (Translation/Libration/Screw) vibrational (anisotropic) motion. It generates all possible partitions up to a maximum number of segments. Each trial partition is scored by how well it explains the observed atomic displacement parameters (**B values**) that came out of crystallographic refinement.

Suitable for medium resolution, when full anisotropy is impossible
Per group (20 parameters):

• **Translation** – 6 parameters

• **Libration** – 6 parameters

• **Screw rotation** – 8 parameters

    ``TLS refinement is often useful when there is NCS. It is often the case that different copies of a molecule in the asymmetric unit have different overall displacements. These can be accounted for by refining TLS parameters for each molecule. The residual atomic displacement parameters (B factors) should then be similar between molecules, and NCS restraints can be applied between them.``

*TLS rigid body model is highly dependent on the quality of the crystal lattice, and conformational flexibility unique to the protein.*
 
 .. toggle-header::
        :header:  **more**
        
                 TLS (Translation/Libration/Screw) is a mathematical model that predicts the local positional displacement of atoms in a crystal structure based on an underlying assumption that each atom acts as a member of a rigid body that is displaced normally about a mean position. This displacement is seen crystallographically as non-spherical electron density at the atomic positions. The net displacement results both from actual vibration of the molecule in the crystal and from the static disorder within the crystal lattice that results from trapping different microconformers of the molecule in different unit cells making up the crystal lattice. The TLS formalism was originally developed to confirm rigid body displacement for small molecule crystallography, which yields high resolution data and precise anisotropic thermal parameters. Its success in predicting the thermal parameters for small molecules makes it tempting for use in macromolecular crystallography where it could potentially be used to find domain and loop flexibility in proteins; however, the challenges in applying the TLS model to macromolecular structures are different than those encountered with small molecules. Most macromolecular structures do not diffract to a high enough resolution to solve for individual atomic anisotropic thermal parameters (six per atom), so isotropic thermal parameters (one per atom) are used instead.

+++++++++++++
Solvent model
+++++++++++++

    **estimation of the bulk solvent contribution to the diffraction**

Typically, a significant part of a macromolecular crystal is occupied by disordered (bulk) solvent, whose contribution to low resolution reflections is quite significant. An atomic model of a macromolecule without the contribution of the bulk solvent cannot describe these low resolution diffraction data correctly.

*low resolution reflections being less sensitive to model imperfection (including the errors in its orientation) are extremely useful for the solution of the translation problem.*

Two types solvent parameters are present:

• **Simple** - Mask-based bulk solvent correction (default)

    *The contribution of bulk solvent to structure factors is strongest at low resolution, although its effect at high resolution is still non-negligible.*

    Mask-based bulk solvent correction

    • Protein region is masked out

    • Solvent region is flattened (set to constant)

    • Structure factors for solvent are calculated: Fsolvent
    

    .. image:: images/doc.task.refmac5.solvent_model.png
        :scale: 90 %

    *Mask based bulk solvent is a standard in all refinement programs. In refmac it is default.*

• **Bulk** - Babinet’s bulk solvent correction `[Tronrud 1997] <https://doi.org/10.1016/S0076-6879(97)77017-4>`_

    • At low resolution electron density is flat
    
    • Solvent and protein regions differ only by density height
    
    .. image:: images/doc.task.refmac5.Bulk_solventpng.png
        :scale: 60 %
        
----------
Restraints
----------
Standard restraints (used by default) include:

• Bond lengths

• Angles

• Chirals

• Planes

• Some torsion angles

• B-values

• VDW repulsions

These help to ensure that the model is chemically sensible

 *we generally deal with restraints, not constraints.*


++++++++++++++++++++++++++++++++++++++++++++++
NCS (Non-Crystallographic Symmetry Restraints)
++++++++++++++++++++++++++++++++++++++++++++++

*Used if there are two copies of the same molecule present.*


• **Local NCS restraints**

    **making the list of corresponding interatomic distances (removing bond and angle related atom pairs)** 

    • Molecules are assumed to be locally similar
    
    • However, they may adopt (slightly) different global conformations
    
    • Restrain differences between local interatomic distances

• **Global NCS restraints** (i.e. restraints based on RMS between atoms of aligned chains) 
    
    **identifying domains**

    • Molecules are superimposed
    
    • Difference between atoms are minimized

+++++++++++++++++++++
Jelly-body restraints
+++++++++++++++++++++

The effect of "jelly-body" restraints is the implicit parameterization between the rigid body and individual atoms.

.. image:: images/jelly-body_restraints.png
        :scale: 30 % 

where class is a restraint class (bonds, angles, torsion angles, etc.); list is the list of all restraints in the given class; t :subscript:`m` denotes the current value calculated from the current model; t :subscript:`i` denotes the ideal/target value (either tabulated in a dictionary or calculated from reference homologous structures); and w(t :subscript:`m` ,t :subscript:`i`) is an additional weighting factor that may depend on the current value calculated from the model. Usually, w(t :subscript:`m` ,t :subscript:`i`) = 1 except when robust estimators are used, as well as for non-bonding interactions. For non-bonding interactions, w(t :subscript:`m` ,t :subscript:`i` ) = 1
when t :subscript:`m` < t :subscript:`i` and 0 otherwise. σ represents target uncertainty (standard deviation), and is usually listed alongside the “ideal” values in the `pre-tabulated dictionary <https://doi.org/10.1107/S0907444904023510>`_.
d :subscript:`m` and d :subscript:`c` denote the current and ideal values of interatomic distances in the model. At every cycle of refnement d
c = d :subscript:`m`, i.e., the current values of the interatomic distances are always taken as the ideal values.

The purpose of this term is to keep the local conformation of the molecule intact, while allowing groups of atoms (e.g., secondary structures,
domains) to move in a concerted fashion. This helps to avoid local minima, increasing the radius of convergence of refnement. Were all pairs of distances restrained with large weights, then the only allowed movement would be a rigid-body movement with six parameters for each domain, i.e., refnement would be reduced to rigid-body ftting. In practice, restraining interatomic distances up  to 4.2 Å with σ = 0.01 or 0.02 Å works suffciently well for a large class of problems.

.. tip::  
        ``Run many cycles (up to 200 with jelly body restraints) on the early stage of refinement (e.g. straight after MR)``


• Does not change likelihood function.

• Does change 2 :superscript:`nd` derivative - curvature, thus changing the search direction.

+++++++++++++++++++++++++++++++
Fourier Shell Correlation (FSC)
+++++++++++++++++++++++++++++++

Fourier shell correlation measures the normalised cross-correlation coefficient between two 3-dimensional volumes over corresponding shells in Fourier space.  FSC calculated over all structure factors. 

The main idea:

    * Correlation between volumes can be written as a product in Fourier space

    * The Fourier space product can be split into shells by radial frequency

    * Compute plot of correlation versus frequency

For “good” maps the FSC would be higher. If we had two maps, and could calculate the FSC between these maps and the “true” maps, then we would prefer the one that had the higher FSC.

**Phases are random, and amplitudes are exact**: In this case, it is clear that the **FSC will be 0**.

**Phases are exact, and amplitudes are random**. In this case we assume that the amplitudes are random but come from a Wilson distribution. **We assume that the amplitudes correspond to a crystal containing atoms, but are not related to the structure at hand.**

With random amplitudes but exact phases, the correlation between the current and “true” maps will be ~78.5%. When phases are random then the FSC will be 0, irrespective of the accuracy of the amplitudes. 

For FSC value is greater than 0.785, if we know that the structure factors have no information about the crystal we are analysing, then it might be better to replace the observations with the expected value of the amplitudes. 

.. Note::  
         using anything other than the expected amplitude will cause sudden jumps in the power spectrum of the Fourier series, resulting in ripples in the map. If absent reﬂections are to be replaced by a constant value then the value must be equal to the expected amplitude (for that resolution).

**Exact phases and nonrandom amplitudes**:  if the correlation between the E-values of the current and “true” structure factors is larger than 47% then it makes sense to use these data, otherwise, it is better to replace the observed amplitudes with 〈|FC|〉 for map calculation. It must be stressed that this 47% threshold is a theoretical value, calculated under the assumption that phases are exact, and amplitudes correspond to a crystal. It is also interesting to note that this result indicates that if the isomorphism between two crystals is 47% then it is possible to use data from one of the crystals to restore missing data from the other.


**ACKNOWLEDGEMENTS**

This article uses materials kindly provided by Dr. Robert Nicholls and Dr. Garib Murshudov, whose help is greatly appreciated.

**REFERENCES**

`Murshudov, G.N., Skubak, P., Lebedev, A.A., Pannu, N.S., Steiner, R.A., Nicholls, R.A., Winn, M.D., Long, F., and Vagin, A.A. (2011)  Acta Cryst. D67: 355-367; <https://doi.org/10.1107/S0907444911001314>`_

`Nicholls R.A., Kovalevskiy O., Murshudov G.N. (2017). Methods Mol Biol. 1607: 565-593. <https://doi.org/10.1007/978-1-4939-7000-1_23>`_

