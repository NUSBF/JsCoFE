.. _custom_workflows:

=======================================
Custom (user-created) project workflows
=======================================

CCP4 Cloud projects can be developed automatically, using one of pre-defined
:ref:`automatic workflows <workflows_guide>`, as well as *custom workflows*,
defined by user.

.. _custom_workflows_use:

--------------------------------------------------
What are custom workflows and how one can use them
--------------------------------------------------

Custom workflow is a script (*WScript*) describing tasks that need to be 
performed and the order of their invocation, *i.e.*, the workflow algorithm.
The script is placed in a plain text file with extension ``.wscript``,
which can be created by most text editors, such as *vim*, *nano*, *notepad*
(Windows), *TextEdit* (Mac) and similar. Make sure that you save file as
"plain text" when using advanced editors such as *MS Word*, *Libre Office*
(not recommended).

Custom workflow can be started in one of 3 ways:

* Import ``.wscript`` file with other needed files, such as ``.mtz``
  (reflections, phases), ``.pdb``, ``.mmcif`` (structure models),
  ``.cif`` (ligand descriptions), ``.lib`` (restraint libraries),
  ``.seq``, in a *single* import task. After importing, the task will
  start workflow automatically if *WScript* is correct and all necessary 
  data files are provided 

* Add ``.wscript`` files to the set of data files in
  :ref:`CloudRun command file <cloudrun>` (use generic :ref:`FILE <cloudrun_FILE>`
  keyword), choose :ref:`import <cloudrun_TASK>` task and execute the
  ``CloudRun`` utility. All file will be uploaded to CCP4 Cloud, project
  created and workflow started automatically

* Add *WScript* to the *My Workflows* list in the *Workflows* tab of the
  *Task List*, after which it can be used as any other task in the
  system.


-------------------------------------
Writing the Workflow script (WScript)
-------------------------------------

The main idea behind workflows is to automate operations when the same
project (or branch of a project) needs to be repeated many (100s) times with 
different input data, and **WScript** is limited to that purpose.

The easiest way to create a **WScript** file is through using **Workflow Creator**
in CCP4 Cloud. Login in your account and open **Task List** in any project.
Then open tab **Workflows**, scroll it to section **My Workflows** in the end
and push button **Add workflow**. This will launch **Workflow Creator** window
with a template script loaded. It makes a good sense to save the newly created
workflow in your personal library, therefore give it a unique *Workflow ID* on 
top of the dialog window. For easier workflow identification in **My Workflows** 
library, you may also change the colour of the workflow icon – simply click on 
it and choose from available options. Now you can save the script – it will
appear in the **My Workflows** section of the **Task List**. You can run it as
any other task now, but doing so will result in an empty **Job Dialog**, because
we only saved a template, which does nothing.

Let's give it a useful content now. Click on **Edit** button on the right from 
the just created workflow in **My Workflows**, this opens **Workflow Creator**
again, with the previous content looking something like this: ::

    #
    # * THIS IS A WORKFLOW SCRIPT TEMPLATE
    # * DO NOT ASSUME THAT IT IS FUNCTIONAL WITHOUT EDITING
    # * CONSULT DOCUMENTATION
    #

    # -----------------------------------------------------
    # Give Workflow Title here
    # -----------------------------------------------------
    # Sun Dec 31 2023
    #

    VERSION  1.0    # script version for backward compatibility
    DEBUG    OFF    # ON/OFF
    COMMENTS ON     # ON/OFF
    WID      d-imp  # (optional) workflow ID for import mode

    # ==========================================================================
    # Workflow header -- EDIT AS NECESSARY

    # General workflow descriptors
    NAME     my workflow             # to show in Job Tree
    ONAME    my_wflow                # to use for naming output files
    TITLE    My Workflow Title       # to display in Task List
    DESC     my workflow description # to display in Task List
    ICON     Maraschino              # (optional) workflow icon colour
    KEYWORDS my own workflow         # for using in A-Z keyword search

    ALLOW_UPLOAD       # create file upload widgets if started from project root

    # ==========================================================================
    # Input data section. List all data required, "!" specifies mandatory items.
    # Edit template statements below as necessary:

    # !DATA HKL UNMERGED TYPES anomalous
    # !DATA XYZ          TYPES protein dna rna
    # DATA LIBRARY
    # DATA SEQ           TYPES protein dna rna
    # DATA LIGAND

    # ==========================================================================
    # Workflow parameters section. List all parameters required, "!" specifies
    # mandatory items. Edit template statements below as necessary:

    # !PAR_INTEGER nCycles  # variable name to be used in workflow's expressions
    #    LABEL     Number of cycles
    #    TOOLTIP   Number of refiniement cycles
    #    IWIDTH    40        # (optional) input field width is set to 40 pixels
    #    RANGE     0 50      # (optional) allowed min/max values
    #    DEFAULT   10        # (optional) default integer value

    # PAR_REAL     resHigh   # variable name to be used in workflow's expressions
    #    LABEL     High resolution cut-off (&Aring;)
    #    TOOLTIP   High resolution cut-off, angstrom
    #    IWIDTH    40        # input field width is set to 40 pixels
    #    RANGE     0.1 5.0   # allowed min/max values
    #    DEFAULT   1.5       # default real value

    # !PAR_STRING  atomType  # variable name to be used in workflow's expressions
    #    LABEL     Anomalous scatterer
    #    TOOLTIP   Expected main anomalous scatterer
    #    IWIDTH    20        # input field width is set to 20 pixels
    #    MAXLENGTH 2         # (optional) maximum 2 characters
    #    DEFAULT   Se        # (optional) default string value "Se"

    # PAR_CHECK    reqValReport # variable name to be used in workflow's expressions
    #    LABEL     Request PDB Validation Report
    #    TOOLTIP   Check if deposition files should be prepared and PDB validation report obtained
    #    DEFAULT   Unchecked

    # !PAR_COMBO   useBFactors # variable name to be used in workflow's expressions
    #    LABEL     Use isotropic B-factors
    #    TOOLTIP   B-factor mode for refinement
    #    IWIDTH    60        # input field width is set to 60 pixels
    #    OPTION    none  Select from list  # value "none" text "Select from list" 
    #    OPTION    yes   Yes               # value "yes"  text "Yes"
    #    OPTION    no    No                # value "no"  text  "No"
    #    DEFAULT   none                    # default string value "none"

    # ==========================================================================
    # Workflow run body

In **WScript** lines, everything on the right from the hash "#" sign is a comment
and may be safely deleted. Perhaps you may want to delete first few lines from
the template, but in general, the more comments you make in the script, the more 
understandable and maintainable it is. You can use spaces to your aesthetic 
preferences; where there must be a space separator, any number of spaces can be
used. 

**WScript** is based on single-line statements, containing keywords and values.
Keywords, which normally start **WScript** statements, are case-insensitive.
Values, on contrary, should be specified with respect to upper/lower case. Full
list of keywords is given in the end of this document.

We will create new workflow in several steps now.

~~~~~~~~~~~~~~~~~~
Simple MR Workflow
~~~~~~~~~~~~~~~~~~

As first example, let's write a simple workflow, which takes reflection data,
structure template, sequence and solves structure with Molecular Replacement
using Molrep.

Firstly, remove unnecessary lines and put a reasonable annotation in the
header section of the **WScript** file, so that it starts with this
workflow header: ::

    #
    # -----------------------------------------------------
    # Molecular Replacement with Molrep
    # -----------------------------------------------------
    # Sun Dec 31 2023
    #

    VERSION  1.0    # script version for backward compatibility
    DEBUG    OFF    # ON/OFF
    COMMENTS ON     # ON/OFF

    # ==========================================================================
    # Workflow header

    # General workflow descriptors
    NAME     molrep workflow         # to show in Job Tree
    ONAME    mrp_wflow               # to use for naming output files
    TITLE    Molrep-based Workflow   # to display in Task List
    DESC     takes HKL, XYZ and SEQ and solves structure with Molrep
    ICON     Maraschino              # (optional) workflow icon colour
    KEYWORDS molrep workflow         # for using in A-Z keyword search

    ALLOW_UPLOAD       # create file upload widgets if started from project root

You may save the workflow now and check how its description changed in
**My Workflows** list. Re-open it again by pushing the relevant **Edit** button.

Secondly, specify data, which workflow will use, in **WScript**'s' input data
section (just append these statements to the script): ::

    # ==========================================================================
    # Input data section. List all data required, "!" specifies mandatory items.

    !DATA HKL
    !DATA XYZ  TYPES protein
    !DATA SEQ  TYPES protein

These statements mean that the workflow requires 3 mandatory items: reflection 
data (HKL), search model (XYZ, must be protein chain(s)) and sequence (SEQ, 
also of aminoacid type). In order to understand what these statements do, save 
the script and create a new task with it from the root of your project – you
should see input fields for data files. To check further, run Cloud's 
**File Import** task and import all needed files, then append your workflow as
the next task – you should see selectors for imported data. You can even run 
the workflows now; it will fail immediately though because we did not specify 
any tasks in the **WScript** file yet.

We now want to make a sequence of at least 5 tasks:

- prepare MR model
- define ASU
- run Molrep
- re-build model with, e.g., Buccaneer
- refine with Refmac

Re-open molrep workflow script in **Workflow Cretor** again. In the bottom of 
the dialog window, click button **Add task** and select *"Model Preparation XYZ"*
in the combobox found in the header. This populates the dialog window with
default task options like in original task interfaces. Choose options that you
want to change, set their values, and push **Add to workflow** button. This
will append the following construct: ::

    @MODELPREPXYZ
        RUN ModelPrepXYZ

to the end of the script if you did not change anything in task parameters.
If a non-default parameter value were chosen, *e.g.*, if you changed
*"Modification protocol"* for *"PDB Clip"*, then the construct would
look slightly different: ::

    @MODELPREPXYZ
        PARAMETER MODIFICATION_SEL D  # Modification protocol
        RUN ModelPrepXYZ

These examples give an idea of how CCP4 Cloud tasks are described in custom 
workflows. Each task is represented by a block of lines, which starts with
*RUN NAME* and finishes with *RUN* statement. *RUN NAME* must be a unique
alphanumeric identifier starting with *"@"* symbol. Other lines between
*RUN NAME* and *RUN* statements may contain values for task parameters,
and only non-default parameters should be specified for brevity. See more
details in Reference below.

Similarly to the *"Model Preparation XYZ"* task, you can now add 
*"ASU Definition"*, *"Molrep"*, *"Buccaneer"* and *"Refmac"* tasks to the
workflow, in that order. The resulting **WScript** will look like
the following: ::

    #
    # -----------------------------------------------------
    # Molecular Replacement with Molrep
    # -----------------------------------------------------
    # Sun Dec 31 2023
    #

    VERSION  1.0    # script version for backward compatibility
    DEBUG    OFF    # ON/OFF
    COMMENTS ON     # ON/OFF

    # ==========================================================================
    # Workflow header

    # General workflow descriptors
    NAME     molrep workflow         # to show in Job Tree
    ONAME    mrp_wflow               # to use for naming output files
    TITLE    Molrep-based Workflow   # to display in Task List
    DESC     takes HKL, XYZ and SEQ and solves structure with Molrep
    ICON     Maraschino              # (optional) workflow icon colour
    KEYWORDS molrep workflow         # for using in A-Z keyword search

    ALLOW_UPLOAD       # create file upload widgets if started from project root

    # ==========================================================================
    # Input data section. List all data required, "!" specifies mandatory items.

    !DATA HKL
    !DATA XYZ  TYPES protein
    !DATA SEQ  TYPES protein

    # ==========================================================================
    # Workflow parameters section. List all parameters required, "!" specifies
    # mandatory items.

    # ==========================================================================
    # Workflow run body

    @MODELPREPXYZ
        RUN ModelPrepXYZ
    #

    @ASUDEF
        RUN ASUDef
    #

    @MOLREP
        RUN PhaserMR
    #

    @BUCCANEER
        RUN Buccaneer
    #

    @REFMAC
        RUN Refmac
    #

This makes a completely functional workflow, which you can run now by any of
the three methods described in :ref:`custom_workflows_use` (you need to
copy-paste **WScript** from **Workflow Creator** into external file with 
``.wscript`` extension for using it with the **Import** task or **CloudRun**
utility).


~~~~~~~~~~~~~~~~~~~~~~
Conditional statements
~~~~~~~~~~~~~~~~~~~~~~

At the moment, our molrep workflow is quite straightforward in respect to its 
input data and algorithm. We may wish to make it more flexible. For example,
it would be good if can take both merged and unmerged reflection data on input,
optimize refinement parameters and, optionally, prepare file for PDB deposition
from best results achieved.

Let's start from optional unmerged reflections input. We can instruct the
workflow to accept both merged and unmerged reflections by modifying the
corresponding ``DATA`` statement as below: ::

    !DATA HKL UNMERGED
    !DATA XYZ  TYPES protein
    !DATA SEQ  TYPES protein


