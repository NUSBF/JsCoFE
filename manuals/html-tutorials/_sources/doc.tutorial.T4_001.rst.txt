===================================================================
Refinement using REFMAC5 - Part 1: Simple Refinement
===================================================================

Written by: Rob Nicholls

-----------------
Preliminary notes
-----------------

* It is essential for this tutorial that CCP4 Cloud is used in remote |ccp4cloud_remote| or desktop |ccp4cloud_desktop| mode.

.. |ccp4cloud_remote| image:: images/ccp4cloud_remote.png
   :width: 20
   :height: 20

.. |ccp4cloud_desktop| image:: images/ccp4cloud_desktop.png
   :width: 20
   :height: 20

* The tutorial project is initialised in *Hop-on* mode. This means that:
   a. The structure is already phased and built
   b. Protein sequence is not imported (and not needed)
   c. The *Task List* is limited to a subset of tasks relevant to structure completion and refinement; if necessary, it can be switched to the full mode.

--------
Tutorial
--------

``1. Reflection data (rnase.mtz), Phases (rnase.mtz) and Atomic coordinates (rnase.pdb) are already imported in the project``

``2. Perform model refinement using default settings``

* Click the green **+** button in order to add a follow-on job. Choose **Refinement with Refmac** from the task list (if not yet in the **Suggested** task list, you can find it in the **Refinement and Model Building** section of the **Full list** of tasks).
* Change the **job description** field to something meaningful, like: "Refine with default settings".
* Click the green arrow at the top of the window to run the job. While a job is running, you can safely click the red cross at the top-right of the window in order to close the job dialog, and the job will continue running in the background. To view the current status of a running job, or to view the results of a completed job, double click on the job in the tree.

``3. Run refinement with a different data-geometry weight``

We now want to try refinement with different parameters, in parallel with the first job that is already running.

* Ensure that the existing refinement job is selected in the project tree, and click the **Clone job** button on the left side of the screen.
* A refinement job window will open – in the **Basic options** section, change **Overall data-geometry weight** to **Fixed** with a value of **1.0**.
* Give the job a meaningful description.
* Click the green arrow at the top of the window to run the job. Again, close the job dialog window while it runs.

``4. Run refinement with different B-factor parameterisation``

* Clone the job again.
* Open the **Model Parameterisation** section, and change **Atomic B-factors** to **Anisotropic**.
* Give the job a meaningful description.
* Click the green arrow at the top of the window to run the job, and close the job dialog window while it runs.

``5. Inspect the refinement results``

In the main project tree, you can now see three refinement jobs that have been run in parallel, all starting from the same structure revision. 

* When the jobs finish, the final R-factors are appended to the job title. Which of the three jobs produced the best R-factors, thus presumably the best model?
* More detailed output can be found by double-clicking on a job. Once the jobs have finished, double-click on the last refinement job in the tree. Does refinement seem to have converged after the default 10 cycles?
* Consider the difference between the R-factors before and after refinement... why do you think they have improved so much?

Note that CCP4 Cloud's Verdict is different for the three jobs - this suggests what parameters you could try changing in order to improve refinement.

``6. Inspect the refined model in Coot``

* Select the last refinement job in the tree. 
* Click the green **+** button in order to add a follow-on job, and select the **Model Building with Coot** task in order to open the Coot job window. 
* By default, the structure revision corresponding to the output of your refinement job will be already selected for opening in Coot. But we also want to load the original model, so that we can compare the model before/after refinement. To do this: in **Additional Structures** select the job ID that corresponds to your **hop on ccp4 cloud** job (which may be called something like **[0001-01] hop-on /structure/**) – this will tell Coot to also open your original model and associated maps. Now run the job in order to open Coot.
* Within Coot, open the Display Manager and repeatedly toggle the two models on and off, to visually compare differences between them. Does it seem that the coordinates corresponding to the model have changed much during refinement?
* Now colour both models according to their B-factors – this is also done in the Display Manager. The models will be coloured on a blue-green-yellow-red scale to indicate low-to-high B-factors. Again, toggle the two models on and off. Does it seem that the B-factors have changed much during refinement? Does this shed any light on why the R-factors improved so much during refinement?
* Now toggle off the model and map corresponding to the original structure revision, so that only the post-refinement model and map are displayed. Select **Unmodelled blobs** from Coot’s **Validate** menu. One large blob should be identified. Zoom into this region. What seems to be missing from the model?
